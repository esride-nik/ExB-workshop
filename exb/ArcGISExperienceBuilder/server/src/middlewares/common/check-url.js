"use strict";var __awaiter=this&&this.__awaiter||function(e,u,c,i){return new(c=c||Promise)(function(t,r){function n(e){try{o(i.next(e))}catch(e){r(e)}}function s(e){try{o(i.throw(e))}catch(e){r(e)}}function o(e){var r;e.done?t(e.value):((r=e.value)instanceof c?r:new c(function(e){e(r)})).then(n,s)}o((i=i.apply(e,u||[])).next())})},__generator=this&&this.__generator||function(n,s){var o,u,c,i={label:0,sent:function(){if(1&c[0])throw c[1];return c[1]},trys:[],ops:[]},l={next:e(0),throw:e(1),return:e(2)};return"function"==typeof Symbol&&(l[Symbol.iterator]=function(){return this}),l;function e(t){return function(e){var r=[t,e];if(o)throw new TypeError("Generator is already executing.");for(;i=l&&r[l=0]?0:i;)try{if(o=1,u&&(c=2&r[0]?u.return:r[0]?u.throw||((c=u.return)&&c.call(u),0):u.next)&&!(c=c.call(u,r[1])).done)return c;switch(u=0,(r=c?[2&r[0],c.value]:r)[0]){case 0:case 1:c=r;break;case 4:return i.label++,{value:r[1],done:!1};case 5:i.label++,u=r[1],r=[0];continue;case 7:r=i.ops.pop(),i.trys.pop();continue;default:if(!(c=0<(c=i.trys).length&&c[c.length-1])&&(6===r[0]||2===r[0])){i=0;continue}if(3===r[0]&&(!c||r[1]>c[0]&&r[1]<c[3]))i.label=r[1];else if(6===r[0]&&i.label<c[1])i.label=c[1],c=r;else{if(!(c&&i.label<c[2])){c[2]&&i.ops.pop(),i.trys.pop();continue}i.label=c[2],i.ops.push(r)}}r=s.call(n,i)}catch(e){r=[6,e],u=0}finally{o=c=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}}},url=(Object.defineProperty(exports,"__esModule",{value:!0}),exports.checkUrl=void 0,require("url")),cross_fetch_1=require("cross-fetch"),rest_common_1=(require("../../global"),require("../rest-common")),utils_1=require("../utils");function checkUrl(s,o){return __awaiter(this,void 0,void 0,function(){var r,t,n;return __generator(this,function(e){switch(e.label){case 0:return r=new rest_common_1.APIResult,t=s.request.body||{},[4,(0,utils_1.checkToken)(null==t?void 0:t.token)];case 1:return e.sent()?[3,3]:(r.setError(rest_common_1.COMMON_ERRORS.invalidCookie),responseResult(s,r),[4,o()]);case 2:return e.sent(),[2];case 3:return(n=!!t.url&&isUrlSecurity(t.url),t.url&&n)?[3,5]:(setAPIResultError(r,rest_common_1.COMMON_ERRORS.invalidParam),responseResult(s,r),[4,o()]);case 4:return e.sent(),[2];case 5:return[4,fetchUrlInfo(t.url).catch(function(e){})];case 6:return(n=e.sent())?(r.success=!0,r.data=n):setAPIResultError(r,rest_common_1.COMMON_ERRORS.fetchUrlError),responseResult(s,r),[4,o()];case 7:return e.sent(),[2]}})})}function fetchUrlInfo(n){return __awaiter(this,void 0,void 0,function(){var t,r;return __generator(this,function(e){switch(e.label){case 0:return t={url:n},process.env.NODE_TLS_REJECT_UNAUTHORIZED="0",[4,(0,cross_fetch_1.default)(n,{method:"HEAD"}).catch(function(e){})];case 1:return(r=e.sent())?(t.status=r.status,t.statusText=r.statusText,400<=r.status||(t.headers={},r.headers&&r.headers.forEach(function(e,r){t.headers[r]=e})),[2,Promise.resolve(t)]):[2,Promise.resolve(null)]}})})}function setAPIResultError(e,r){e.success=!1,e.error=r}function responseResult(e,r){e.type="json",e.body=JSON.stringify(r)}function isUrlSecurity(e){if(!e)return!1;try{var r=url.parse(e),t=null==r?void 0:r.protocol,n=null==r?void 0:r.hostname,s="https:"!==t?!1:!0;return 0==n.indexOf("localhost")&&(s=!1),s=0==n.indexOf("127")||"169.254.169.254"==n||-1<e.indexOf("::1")?!1:s}catch(e){return!1}}exports.checkUrl=checkUrl;