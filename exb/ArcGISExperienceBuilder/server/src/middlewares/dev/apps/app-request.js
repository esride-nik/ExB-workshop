"use strict";var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,r=1,s=arguments.length;r<s;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},__awaiter=this&&this.__awaiter||function(e,i,a,c){return new(a=a||Promise)(function(r,t){function s(e){try{n(c.next(e))}catch(e){t(e)}}function o(e){try{n(c.throw(e))}catch(e){t(e)}}function n(e){var t;e.done?r(e.value):((t=e.value)instanceof a?t:new a(function(e){e(t)})).then(s,o)}n((c=c.apply(e,i||[])).next())})},__generator=this&&this.__generator||function(s,o){var n,i,a,c={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},u={next:e(0),throw:e(1),return:e(2)};return"function"==typeof Symbol&&(u[Symbol.iterator]=function(){return this}),u;function e(r){return function(e){var t=[r,e];if(n)throw new TypeError("Generator is already executing.");for(;c=u&&t[u=0]?0:c;)try{if(n=1,i&&(a=2&t[0]?i.return:t[0]?i.throw||((a=i.return)&&a.call(i),0):i.next)&&!(a=a.call(i,t[1])).done)return a;switch(i=0,(t=a?[2&t[0],a.value]:t)[0]){case 0:case 1:a=t;break;case 4:return c.label++,{value:t[1],done:!1};case 5:c.label++,i=t[1],t=[0];continue;case 7:t=c.ops.pop(),c.trys.pop();continue;default:if(!(a=0<(a=c.trys).length&&a[a.length-1])&&(6===t[0]||2===t[0])){c=0;continue}if(3===t[0]&&(!a||t[1]>a[0]&&t[1]<a[3]))c.label=t[1];else if(6===t[0]&&c.label<a[1])c.label=a[1],a=t;else{if(!(a&&c.label<a[2])){a[2]&&c.ops.pop(),c.trys.pop();continue}c.label=a[2],c.ops.push(t)}}t=o.call(s,c)}catch(e){t=[6,e],i=0}finally{n=a=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}}},__spreadArray=this&&this.__spreadArray||function(e,t,r){if(r||2===arguments.length)for(var s,o=0,n=t.length;o<n;o++)!s&&o in t||((s=s||Array.prototype.slice.call(t,0,o))[o]=t[o]);return e.concat(s||Array.prototype.slice.call(t))},fs=(Object.defineProperty(exports,"__esModule",{value:!0}),exports.buildItem=exports.removeResources=exports.resource=exports.resources=exports.updateResources=exports.addResources=exports.removeItem=exports.searchItem=exports.items=exports.getItemData=exports.updateAppItem=exports.addItem=void 0,require("fs-extra")),fetch=require("cross-fetch"),utils_1=(require("../../../global"),require("./utils")),url=(require("isomorphic-form-data"),global.fetch=fetch,require("url")),uploadThumbnail=(0,utils_1.getThumbnailUpdateMulter)(),upload=(0,utils_1.getUploadMulter)();function addItem(f,_){return __awaiter(this,void 0,void 0,function(){var t,r,s,o,n,i,a,c,u,l,d,p;return __generator(this,function(e){switch(e.label){case 0:t={error:{message:"",success:!1}};try{if(f.type="json",(r=f.request.body||{}).typeKeywords?r.typeKeywords=Array.isArray(r.typeKeywords)?r.typeKeywords:r.typeKeywords.split(","):delete r.typeKeywords,r.hasOwnProperty("snippet")&&delete r.snippet,delete r.thumbnail,s=(0,utils_1.addItemParamsIsPass)(r))return t.error.message=s,[2,(0,utils_1.requestException)(t,f)];fs.ensureDirSync(utils_1.appFolderPath),o=Date.now(),n=fs.readdirSync(utils_1.appFolderPath),i=(0,utils_1.getFolderIndex)(n,0)+"",r.id=i,r.created=o,r.modified=o,r.owner=r.username,delete(a=__assign(__assign({},utils_1.infoJson),r)).text,a=(0,utils_1.deepClone)(a),c="".concat(utils_1.appFolderPath,"/").concat(i),fs.mkdirSync(c),u=JSON.stringify(a,null,2),fs.writeFileSync("".concat(c,"/info.json"),u),l={__not_publish:!0},d=JSON.stringify(l),r.text&&(d="string"==typeof r.text?r.text:JSON.stringify(r.text,null,2)),fs.writeFileSync("".concat(c,"/config.json"),d),p={folder:"apps/".concat(i),id:i,success:!0},(0,utils_1.commonResponse)(f,p)}catch(e){t.error.message=e,(0,utils_1.writeResponseLog)(e,!0),f.body=t}return[4,_()];case 1:return e.sent(),[2]}})})}function updateAppItem(u,r){return __awaiter(this,void 0,void 0,function(){var c,t;return __generator(this,function(e){switch(e.label){case 0:c={message:"",itemId:"",success:!1},e.label=1;case 1:return e.trys.push([1,3,,4]),[4,uploadThumbnail.single("thumbnail")(u,r).then(function(e){var t=u.request.body||{},r=(0,utils_1.getIdFromUrl)(u),s=u.request.headers["content-type"],o=(delete t.thumbnail,t.typeKeywords?t.typeKeywords=Array.isArray(t.typeKeywords)?t.typeKeywords:t.typeKeywords.split(","):delete t.typeKeywords,"".concat(utils_1.appFolderPath,"/").concat(r,"/info.json")),n="".concat(utils_1.appFolderPath,"/").concat(r,"/config.json");if(!fs.existsSync(o)||!fs.existsSync(n))return c.message="no file",c.itemId=r,(0,utils_1.requestException)(c,u);var i,a=JSON.parse(fs.readFileSync(o,"utf8")),s=(-1!=s.indexOf("/form-data")&&(s=fs.readdirSync("".concat(utils_1.appFolderPath,"/").concat(r,"/thumbnail")),a.thumbnail="thumbnail/".concat(s[0])),t.text&&(s="string"==typeof t.text?JSON.parse(t.text):t.text,i=JSON.stringify(__assign({},s),null,2),(null==s?void 0:s.__not_publish)||fs.writeFileSync(n,i),delete t.text),t.username&&(t.owner=t.username),t.modified=Date.now(),JSON.stringify(__assign(__assign({},a),t),null,2));fs.writeFileSync(o,s),(0,utils_1.commonResponse)(u,{id:r,success:!0})}).catch(function(e){c.message="upload failed",u.body=c})];case 2:return e.sent(),[3,4];case 3:return t=e.sent(),c.message=t,(0,utils_1.writeResponseLog)(t,!0),u.body=c,[3,4];case 4:return[2]}})})}function getItemData(a,c){return __awaiter(this,void 0,void 0,function(){var t,r,s,o,n,i;return __generator(this,function(e){switch(e.label){case 0:t={error:{message:"",id:"",success:!1}};try{if(r=(0,utils_1.getIdFromUrl)(a),s="".concat(utils_1.appFolderPath,"/").concat(r,"/config.json"),!fs.existsSync(s))return t.error.message="no file",t.error.id=r,o={message:"no item",id:r,success:!1},(0,utils_1.commonResponse)(a,o),[2,!1];n=JSON.parse(fs.readFileSync(s,"utf8")),i=__assign(__assign({},n),{id:r,success:!0}),(0,utils_1.commonResponse)(a,i)}catch(e){t.error.message=e,(0,utils_1.writeResponseLog)(e,!0),a.body=t}return[4,c()];case 1:return e.sent(),[2]}})})}function items(a,c){return __awaiter(this,void 0,void 0,function(){var t,r,s,o,n,i;return __generator(this,function(e){switch(e.label){case 0:if(t={error:{message:"",id:"",success:!1}},r=a.req.url,!(-1!=r.indexOf("/sharing/rest/content/users/items")&&7==r.split("/").length))return[2,!1];try{if(s=(0,utils_1.getIdFromUrl)(a,0),o="".concat(utils_1.appFolderPath,"/").concat(s,"/info.json"),!fs.existsSync(o))return t.error.message="Item does not exist or is inaccessible.",t.error.id=s,[2,(0,utils_1.requestException)(t,a)];n=JSON.parse(fs.readFileSync(o,"utf8")),i=__assign(__assign({},n),{id:s,success:!0}),(0,utils_1.commonResponse)(a,i)}catch(e){t.error.message=e,(0,utils_1.writeResponseLog)(e,!0),a.body=t}return[4,c()];case 1:return e.sent(),[2]}})})}function searchItem(w,b){var v,x,I;return __awaiter(this,void 0,void 0,function(){var t,r,s,o,n,i,a,c,u,l,d,p,f,_,m,h,y,g;return __generator(this,function(e){switch(e.label){case 0:try{t=[],r=void 0,s=w.request.method,r="GET"==s?url.parse(w.request.url,!0).query:w.request.body||{},o=utils_1.appFolderPath,fs.existsSync(o)&&(n=fs.readdirSync(o),i=r.q,a="",i&&-1!=i.indexOf(")")&&(c=i.split("owner:")||[],null!=(v=null===c?void 0:c[1]))&&v.includes("(")&&(a=null==(I=null==(x=c[1])?void 0:x.split("(")[1])?void 0:I.split(")")[0]),i&&-1!=i.indexOf("title:")&&(a=i?i.split("title:")[1]:""),u=[],n.forEach(function(e){var e="".concat(o,"/").concat(e,"/info.json");fs.pathExistsSync(e)&&(e=JSON.parse(fs.readFileSync(e,"utf-8")),u.push(e))}),t=(0,utils_1.fuzzyMatching)(u,a,"title",!0)),t=(0,utils_1.filterByType)(t,r.q),l=t,d=(0,utils_1.getOwner)(r.q),l=(0,utils_1.filterDataByOwner)(l,d.owner,d.isNot),p=(0,utils_1.getTypekeywords)(r.q),l=(0,utils_1.filterDataByTypekeywords)(l,p.typekeywords,p.isNot),(f=null==r?void 0:r.portalUrl)&&(l=(0,utils_1.filterDataByPortalUrl)(l,f)),r.sortOrder&&(l=(0,utils_1.sortByNumber)(l,"created",r.sortOrder)),"modified"!=r.sortField&&"created"!=r.sortField||(l=(0,utils_1.sortByNumber)(l,r.sortField)),"title"==r.sortField&&(l=(0,utils_1.sortByInitial)(l,r.sortField)),_=Number(r.start)||0,m=Number(r.num)||10,h=_+m,y=[],l.forEach(function(e,t){t+=1;_<=t&&t<h&&y.push(e)}),g={nextStart:h,num:y.length,query:r.q,results:y,start:r.start,total:l.length},(0,utils_1.commonResponse)(w,g)}catch(e){(0,utils_1.writeResponseLog)(e,!0),w.body=e}return[4,b()];case 1:return e.sent(),[2]}})})}function removeItem(n,i){return __awaiter(this,void 0,void 0,function(){var t,r,s,o;return __generator(this,function(e){switch(e.label){case 0:t={message:"",itemId:"",success:!1};try{if(r=(0,utils_1.getIdFromUrl)(n),s="".concat(utils_1.appFolderPath,"/").concat(r),!fs.existsSync(s))return t.message="no folder",t.itemId=r,[2,(0,utils_1.requestException)(t,n)];fs.removeSync(s),o={id:r,success:!0},(0,utils_1.commonResponse)(n,o)}catch(e){t.message=e,(0,utils_1.writeResponseLog)(e,!0),n.body=t}return[4,i()];case 1:return e.sent(),[2]}})})}function addResources(o,s){return __awaiter(this,void 0,void 0,function(){var t,r;return __generator(this,function(e){switch(e.label){case 0:t={error:{message:"",details:[],success:!1}},e.label=1;case 1:return e.trys.push([1,3,,4]),[4,upload.single("file")(o,s).then(function(e){var t=(0,utils_1.getIdFromUrl)(o),r=o.request.body,s="".concat(utils_1.appFolderPath,"/").concat(t,"/resources/").concat(r.resourcesPrefix,"/").concat(r.fileName),s=((0,utils_1.formatJson)(s,r.fileName),(0,utils_1.getOwnerFromInfo)(t));(0,utils_1.commonResponse)(o,{folder:t,itemId:t,owner:s,success:!0})}).catch(function(e){t.error.message="upload failed",o.body=t})];case 2:return e.sent(),[3,4];case 3:return r=e.sent(),t.error.message=r,(0,utils_1.writeResponseLog)(r,!0),o.body=t,[3,4];case 4:return[2]}})})}function updateResources(n,s){return __awaiter(this,void 0,void 0,function(){var t,r;return __generator(this,function(e){switch(e.label){case 0:t={message:"",success:!1},e.label=1;case 1:return e.trys.push([1,3,,4]),[4,upload.single("file")(n,s).then(function(e){var t=(0,utils_1.getIdFromUrl)(n),r=n.request.body,s="".concat(utils_1.appFolderPath,"/").concat(t,"/resources/").concat(r.resourcesPrefix,"/").concat(r.fileName),o=(0,utils_1.getOwnerFromInfo)(t),s=((0,utils_1.formatJson)(s,r.fileName),{folder:t,itemId:t,owner:o,success:!0});(0,utils_1.commonResponse)(n,s)}).catch(function(e){t.message="upload failed",n.body=t})];case 2:return e.sent(),[3,4];case 3:return r=e.sent(),t.message=r,(0,utils_1.writeResponseLog)(r,!0),n.body=t,[3,4];case 4:return[2]}})})}function resources(i,a){return __awaiter(this,void 0,void 0,function(){var t,r,s,o,n;return __generator(this,function(e){switch(e.label){case 0:try{if(t=(0,utils_1.getIdFromUrl)(i),r="".concat(utils_1.appFolderPath,"/").concat(t,"/resources"),!fs.existsSync(r))return s={total:0,start:1,num:0,nextStart:-1,resources:[],success:!1},(0,utils_1.commonResponse)(i,s),[2,!1];o=(0,utils_1.readFolder)(r,"resources/"),n={total:o.length,start:1,num:o.length,nextStart:-1,resources:o,success:!0},(0,utils_1.commonResponse)(i,n)}catch(e){(0,utils_1.writeResponseLog)(e,!0),i.body=e}return[4,a()];case 1:return e.sent(),[2]}})})}function resource(n,i){return __awaiter(this,void 0,void 0,function(){var t,r,s,o;return __generator(this,function(e){switch(e.label){case 0:try{if(t=n.params.id,r=n.params.resourceName,s="".concat(utils_1.appFolderPath,"/").concat(t,"/resources/").concat(r),!fs.existsSync(s))return[2,!(n.response.status=404)];o=fs.readFileSync(s,"utf-8"),(0,utils_1.commonResponse)(n,o)}catch(e){(0,utils_1.writeResponseLog)(e,!0),n.body=e}return[4,i()];case 1:return e.sent(),[2]}})})}function removeResources(i,a){return __awaiter(this,void 0,void 0,function(){var t,r,s,o,n;return __generator(this,function(e){switch(e.label){case 0:t={error:{code:404,message:"",details:[],id:"",success:!1}};try{if((r=i.request.body||{}).deleteAll=!!r.hasOwnProperty("deleteAll")&&r.deleteAll,s=(0,utils_1.getIdFromUrl)(i),t.error.id=s,!r.deleteAll&&!r.resource)return t.error.message="no resource",[2,(0,utils_1.requestException)(t,i)];if(o=r.deleteAll?"".concat(utils_1.appFolderPath,"/").concat(s,"/resources"):"".concat(utils_1.appFolderPath,"/").concat(s,"/resources/").concat(r.resource),!fs.existsSync(o))return t.error.message="no folder",[2,(0,utils_1.requestException)(t,i)];fs.removeSync(o),n={id:s,success:!0},(0,utils_1.commonResponse)(i,n)}catch(e){t.error.message=e,(0,utils_1.writeResponseLog)(e,!0),i.body=t}return[4,a()];case 1:return e.sent(),[2]}})})}function buildItem(n,i){return __awaiter(this,void 0,void 0,function(){var t,r,s,a,c,o;return __generator(this,function(e){switch(e.label){case 0:t={error:{message:"",itemId:"",detail:Object,success:!1}},e.label=1;case 1:return e.trys.push([1,3,,4]),r=require("child_process"),s=require("path"),a=(0,utils_1.getIdFromUrl)(n),c=function(e,t){for(var r=[],s=2;s<arguments.length;s++)r[s-2]=arguments[s];return t="[".concat(Date(),"] ").concat(t),console[e].apply(console,r.length?__spreadArray(__spreadArray(["".concat(">".repeat(60),"\n").concat(t,"\n")],r,!0),["\n".concat(t,"\n").concat("<".repeat(60))],!1):["".concat(t)])},[4,Promise.resolve("").then(function(e){return new Promise(function(n,i){var e=s.resolve(__dirname,"../../../../logs/experience-app-build-".concat((new Date).toISOString().split("T").shift(),".log"));r.exec('npx webpack --config="./webpack/webpack-experience-app-build.config.js" --expAppId="'.concat(a,'" >> "').concat(e,'" 2>&1'),{cwd:s.resolve(__dirname,"../../../../../client"),timeout:1e6},function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=e[0],s=e[1],o=e[2];s&&console.log("[".concat(Date(),"] stdout: \n").concat(s)),o&&console.error("[".concat(Date(),"] stderr: \n").concat(o)),r?(c("error","========== buildItem ========== FAILED for AppId ".concat(a),r),i(e)):(c("info","========== buildItem ========== SUCCEEDED for AppId ".concat(a,"!")),n(s))})})}).then(function(e){var t=(0,utils_1.getOwnerFromInfo)(a),t={folder:a,itemId:a,owner:t,success:!0,result:e.toString()};(0,utils_1.commonResponse)(n,t)}).catch(function(e){t.error.message="build failed",t.error.itemId=a,t.error.detail=e,n.body=t})];case 2:return e.sent(),[3,4];case 3:return o=e.sent(),t.error.message=o,(0,utils_1.writeResponseLog)(o,!0),n.body=t,[3,4];case 4:return[4,i()];case 5:return e.sent(),[2]}})})}exports.addItem=addItem,exports.updateAppItem=updateAppItem,exports.getItemData=getItemData,exports.items=items,exports.searchItem=searchItem,exports.removeItem=removeItem,exports.addResources=addResources,exports.updateResources=updateResources,exports.resources=resources,exports.resource=resource,exports.removeResources=removeResources,exports.buildItem=buildItem;